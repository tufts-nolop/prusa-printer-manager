{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printer Details</title>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.26.4/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" media="all" href="{% static 'css/single_printer.css' %}" type="text/css">
</head>

<body>
    <div class="container">
        <header>
            <h1>{{ printer.name }} Details</h1>
        </header>

        <div class="detail-view">
            <a href="{% url 'printers:printers' %}" class="back-btn">‚Üê Back to Dashboard</a>

            <div class="detail-header">
                {% if printer.model == "mk4"%}
                    <div class="detail-icon" id="detailIcon"><img
                        src="{% static 'images/mk4.png' %}"/></div>
                {% else %}
                    <div class="detail-icon" id="detailIcon"><img
                        src="{% static 'images/coreone.png' %}"/></div>
                {% endif %}
                <div class="detail-info">
                    <h2 id="detailName">Status: </h2>
                    <p id="detailModel"></p>
                    <div class="status-badge" id="detailStatus">Unavailable</div>
                </div>
            </div>

            <div class="notes-section" id="notesSection">
                <h3>üìù Staff Notes</h3>
                <p id="staffNotes">{{ printer.staff_notes }}</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Temperature</div>
                    <div class="stat-value" id="detailTemp">--¬∞C</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Bed Temp</div>
                    <div class="stat-value" id="detailBedTemp">--¬∞C</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Progress</div>
                    <div class="stat-value" id="detailProgress">--%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Time Remaining</div>
                    <div class="stat-value" id="detailTime">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Last Maintenance</div>
                    {% if printer.last_maintenance|date:"F j, Y, P" %}
                        <div class="stat-value" id="lastMaintenance">{{ printer.last_maintenance|date:"F j, Y, P" }}</div>
                    {% else %}
                        <div class="stat-value" id="lastMaintenance">--</div>
                    {% endif %}
                </div>
            </div>

            <div class="additional-stats">
                <h3>Projected Filament Usage</h3>
                <div class="stat-card">
                    <div class="stat-label">Exact extruded length</div>
                    <div class="stat-value">
                        {% if usage_mm %}
                            {{ usage_mm }}
                        {% else %}
                            --mm
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Printed plastic volume</div>
                    <div class="stat-value">
                        {% if usage_cm3 %}
                            {{ usage_cm3 }}
                        {% else %}
                            --cm¬≥
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Raw material consumption (mass)</div>
                    <div class="stat-value">
                        {% if usage_g %}
                            {{ usage_g }}
                        {% else %}
                            --g
                    </div>
                </div>
            </div>

            {% if request.user.is_superuser %}
            <div class="additional-stats">
                <h3>Printer Statistics</h3>
                <div class="stat-card">
                    <div class="stat-label">Successful Print Rate</div>
                    <div class="stat-value">{{ success_rate }} %</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Prints To Date</div>
                    <div class="stat-value">{{ total_prints }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">CHANGE TO DIFFERENT STAT LATER</div>
                    <div class="stat-value">{{ total_prints }} %</div>
                </div>
            </div>

            <div class="additional-stats">
                <h3>Total Filament Usage</h3>
                <div class="stat-card">
                    <div class="stat-label">Total extruded length</div>
                    <div class="stat-value">{{ total_filament_usage_mm }} mm</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total printed plastic volume</div>
                    <div class="stat-value">{{ total_filament_usage_cm3 }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total filament mass used</div>
                    <div class="stat-value">{{ total_filament_usage_g }} %</div>
                </div>
            </div>
            {% endif %}

            <div class="actions">
                <h3>Upload Print File</h3>
                <div class="upload-section">
                    <form id="uploadForm" onsubmit="uploadFile(event)">
                        <div class="form-group">
                            <label for="fileUpload">Select .bgcode file</label>
                            <input type="file" id="fileUpload" accept=".bgcode" required>
                            <div class="file-info" id="fileInfo"></div>
                        </div>
                        <button type="submit" class="btn-submit">Upload Print</button>
                    </form>
                </div>
            </div>

            <!-- Staff feature to be implemented
            <div class="actions">
                <h3>Actions</h3>
                <div class="action-buttons">
                    <button class="action-btn btn-secondary" onclick="performAction('pause')">Pause</button>
                    <button class="action-btn btn-secondary" onclick="performAction('resume')">Resume</button>
                </div>
            </div> -->

            <!-- <div class="report-section">
                <h3>Report an Issue</h3>
                <form id="reportForm" onsubmit="submitReport(event)">
                    <div class="form-group">
                        <label for="issueType">Issue Type</label>
                        <select id="issueType" required>
                            <option value="">Select an issue type...</option>
                            <option value="mechanical">Mechanical Problem</option>
                            <option value="heating">Heating/Temperature Issue</option>
                            <option value="filament">Filament Jam/Loading</option>
                            <option value="quality">Print Quality Issue</option>
                            <option value="electrical">Electrical Problem</option>
                            <option value="software">Software/Firmware Issue</option>
                            <option value="maintenance">Maintenance Required</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="issueDescription">Description</label>
                        <textarea id="issueDescription" placeholder="Please describe the issue in detail..."
                            required></textarea>
                    </div>
                    <button type="submit" class="btn-submit">Submit Report</button>
                </form>
            </div> -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.26.4/dist/sweetalert2.all.min.js"></script>
    <script>
        function isBgcodeFile(file) {
            if (!file) return false;

            const name = file.name.toLowerCase();
            return name.endsWith(".bgcode");
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function uploadFile(event) {
            event.preventDefault();

            const fileInput = document.getElementById('fileUpload');
            const fileInfo  = document.getElementById('fileInfo');
            const file = fileInput.files[0];

            if (!fileInput.files.length) {
                fileInfo.textContent = "Please choose a file first";
                return;
            }

            if (!isBgcodeFile(file)) {
                fileInfo.textContent = "File must be a .bgcode file";
                fileInput.value = "";
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('slug', "{{ printer.slug }}"); 

            fileInfo.textContent = 'Uploading...';

            try {
                const res = await fetch("{% url 'printers:upload_bgcode_api' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
                credentials: 'same-origin',
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`Upload failed: ${res.status} ${text}`);
                }

                const data = await res.json();
                Swal.fire({
                    icon: 'success',
                    title: 'File uploaded',
                    text: `File "${data.filename || file.name}" was uploaded and queued.`,
                });
                fileInput.value = '';
                fileInfo.textContent = '';
            } catch (err) {
                console.error(err);
                fileInfo.textContent = 'Error uploading file.';
                Swal.fire({ icon: 'error', title: 'Upload failed', text: err.message });
                }
            }

        async function getPrinterData(slug) {
            const csrftoken = getCookie('csrftoken');

            const res = await fetch("{% url 'printers:individual_printer_api' %}", {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRFToken': csrftoken,
                },
                credentials: 'same-origin',
                
                body: JSON.stringify({ slug: slug }), 
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(`HTTP ${res.status}: ${text}`);
            }

            return res.json();
        }

        async function displayPrinterStats(slug) {
            printer = await getPrinterData(slug);
            console.log(printer.curr_status);

            // printer.status = "printing"

            const statusBadge = document.getElementById('detailStatus');
            statusBadge.textContent = printer.curr_status.charAt(0).toUpperCase() + printer.curr_status.slice(1);
            statusBadge.className = `status-badge status-${printer.curr_status}`;

            document.getElementById('detailTemp').textContent = printer.nozzle_temp > 0 ? `${printer.nozzle_temp}¬∞C` : '--¬∞C';
            document.getElementById('detailBedTemp').textContent = printer.bed_temp > 0 ? `${printer.bed_temp}¬∞C` :
            '--¬∞C';

            if (printer.curr_status == 'error' || printer.curr_status == 'ready' || printer.curr_status == 'operational') {
                document.getElementById('detailProgress').textContent = "--%";
                document.getElementById('progressBar').style.width = "0%";
                document.getElementById('detailTime').textContent = "--";
            } else {
                document.getElementById('detailProgress').textContent = `${printer.progress}%`;
                document.getElementById('progressBar').style.width = `${printer.progress}%`;
                document.getElementById('detailTime').textContent = printer.time_remaining + printer.time_units;
            }

            console.log(printer.last_maintenance);
            document.getElementById('lastMaintenance').textContent = printer.last_maintenance;
        }

        function performAction(action) {
            // Replace this with your backend API call
            // Example: fetch(`/api/printers/${printerId}/actions`, { method: 'POST', body: JSON.stringify({ action }) });
            alert(
                `Action performed: ${action.toUpperCase()}\nPrinter ID: ${printerId}\nThis would send a command to your backend.`);
        }

        function submitReport(event) {
            event.preventDefault();
            const issueType = document.getElementById('issueType').value;
            const description = document.getElementById('issueDescription').value;

            // Replace this with your backend API call
            // Example: fetch(`/api/printers/${printerId}/reports`, { method: 'POST', body: JSON.stringify({ issueType, description }) });

            alert(
                `Report Submitted!\n\nPrinter ID: ${printerId}\nIssue Type: ${issueType}\nDescription: ${description}\n\nThis would be sent to your backend.`);

            document.getElementById('reportForm').reset();
        }

        // Load printer data when page loads
        // loadPrinterData();
        const printer_slug = '{{ printer.slug }}';
        displayPrinterStats(printer_slug);
        setInterval(function() { displayPrinterStats(printer_slug); }, 1000);
    </script>
</body>

</html>